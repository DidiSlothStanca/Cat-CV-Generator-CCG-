<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat CV Generator (CCG)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

    <style>
        :root {
            --bg-site: #f1f5f9;
            --editor-card: #ffffff;
            --cv-text: #000000;
            --accent-color: #000000;
            --title-color: #000000;
            --cv-scale: 0.55; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { 
            background-color: var(--bg-site); 
            padding-bottom: 20px; 
            min-height: 100vh;
        }

        .container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 10px; 
        }
        
        header { 
            background: white; 
            padding: 15px 0; 
            border-bottom: 1px solid #e2e8f0; 
            margin-bottom: 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }
        .nav-flex { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .logo { font-size: 1.2rem; font-weight: 800; color: #000; }

        .editor-container { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px; 
        }

        @media (min-width: 1100px) {
            .container { padding: 20px; }
            .editor-container { 
                grid-template-columns: 450px 1fr; 
                gap: 40px; 
                height: calc(100vh - 140px);
            }
            .logo { font-size: 1.5rem; }
            :root { --cv-scale: 0.52; }
        }

        .preview-pane {
            width: 100%;
            background: #cbd5e1;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            padding: 15px 10px;
            min-height: calc(297mm * var(--cv-scale) + 40px);
        }

        @media (min-width: 1100px) {
            .preview-pane {
                height: calc(100vh - 180px);
            }
        }

        #previewContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .cv-page {
            background: white; 
            width: 210mm; 
            min-height: 297mm;
            max-height: 297mm;
            padding: 15mm 15mm 20mm 15mm;
            color: var(--cv-text);
            display: flex;
            flex-direction: column;
            transform: scale(var(--cv-scale));
            transform-origin: top center;
            flex-shrink: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        /* Nomor halaman di pojok kanan bawah */
        .page-number {
            position: absolute;
            bottom: 10mm;
            right: 15mm;
            font-size: 9pt;
            color: #666;
            font-style: italic;
            font-weight: 600;
        }

        @media (max-width: 480px) { 
            :root { --cv-scale: 0.35; } 
            .preview-pane { min-height: calc(297mm * var(--cv-scale) + 40px); }
        }
        @media (min-width: 481px) and (max-width: 768px) { 
            :root { --cv-scale: 0.45; } 
        }
        @media (min-width: 769px) and (max-width: 1099px) { 
            :root { --cv-scale: 0.65; } 
        }

        .form-card { 
            background: var(--editor-card); 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }

        @media (min-width: 1100px) {
            .form-card {
                height: calc(100vh - 180px);
                overflow-y: auto;
                position: relative;
            }
            
            .form-card::-webkit-scrollbar {
                width: 6px;
            }

            .form-card::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }

            .form-card::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }

            .form-card::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        }

        .section-box { background: #fdfdfd; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; position: relative; }
        .section-box h3 { font-size: 1rem; margin-bottom: 12px; color: #1e293b; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; color: #64748b; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        
        .btn { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-add { background: #f1f5f9; color: #000; width: 100%; justify-content: center; border: 1px dashed #000; margin-top: 5px; }
        .btn-success { background: #000000; color: white; width: 100%; justify-content: center; font-size: 1.1rem; padding: 15px; margin-bottom: 20px; }

        .color-picker-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
        }
        
        .color-picker-item label { 
            margin-bottom: 0; 
            color: #92400e; 
            font-size: 0.75rem;
            font-weight: 600;
            flex: 1;
        }
        
        .color-input { 
            width: 40px; 
            height: 30px; 
            padding: 0; 
            border: none; 
            cursor: pointer; 
            background: none;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }

        .cv-main-title { 
            text-align: center; 
            font-size: 22pt; 
            font-weight: 900; 
            letter-spacing: 5px; 
            margin-bottom: 15px; 
            padding-bottom: 5px; 
            text-transform: uppercase; 
            border-bottom: 2px solid var(--title-color);
            color: var(--title-color);
        }
        .cv-header { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 5px; width: 100%; }
        .cv-photo-box { width: 110px; height: 110px; background: #eee; border: 1px solid #000; flex-shrink: 0; }
        .cv-photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .cv-name-zone { flex-grow: 1; }
        .cv-name-zone h1 { font-size: 24pt; line-height: 1.1; margin-bottom: 2px; word-break: break-word; }
        .cv-name-zone p { font-size: 13pt; font-weight: 700; color: var(--accent-color); margin-bottom: 8px; }

        .cv-contact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 20px; font-size: 8.5pt; margin-top: 5px; }
        .cv-contact-item { display: flex; align-items: center; gap: 6px; word-break: break-word; }
        .cv-contact-item i { width: 14px; text-align: center; color: #333; flex-shrink: 0; }

        .cv-sec-title { 
            border-bottom: 1.5px solid var(--accent-color); 
            text-transform: uppercase; 
            font-size: 11pt; 
            font-weight: 800; 
            margin: 15px 0 8px 0; 
            padding-bottom: 2px;
            color: var(--accent-color);
        }

        .cv-entry { margin-bottom: 10px; }
        .cv-entry-head { display: flex; justify-content: space-between; margin-bottom: 1px; }
        .cv-company { 
            color: #000000; 
            font-weight: 800; 
            font-size: 10.5pt; 
        }
        .cv-year { 
            color: #000000; 
            font-weight: 700; 
            font-size: 10.5pt;
        }
        .cv-entry-posisi { 
            color: #000; 
            font-weight: 500; 
            font-size: 10pt; 
            text-transform: none; 
            display: block; 
            margin-bottom: 2px; 
            padding-left: 12px; 
        }
        
        .cv-text, .cv-entry-desc { 
            font-size: 9.5pt; 
            line-height: 1.5; 
            text-align: justify; 
            white-space: pre-line;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .cv-entry-desc { 
            color: #000000; 
            border-top: 1px solid #f0f0f0;
            padding-top: 2px; 
            margin-top: 1px; 
            margin-left: 12px; 
        }

        /* Sertifikat dan Prestasi format */
        .cv-certificate-list {
            font-size: 9.5pt;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        .cv-certificate-item {
            display: flex;
            margin-bottom: 4px;
        }

        .cv-certificate-bullet {
            flex-shrink: 0;
            width: 12px;
            padding-right: 5px;
        }

        .cv-certificate-text {
            flex: 1;
            text-align: left;
        }

        /* Skill badges */
        .badge-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            margin-top: 5px; 
        }
        .cv-badge { 
            border: 1px solid #000; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 8pt; 
            font-weight: 700; 
            background-color: #f8fafc;
        }

        .cv-footer-social { 
            margin-top: 20px; 
            padding-top: 12px; 
            border-top: 1px solid var(--title-color);
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            gap: 15px; 
            font-size: 8.5pt; 
            margin-bottom: 5mm;
        }
        
        .cv-footer-social span { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-weight: 600;
            color: var(--title-color);
        }

        /* Placeholder help text */
        .help-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 3px;
            font-style: italic;
        }

        #cropModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .crop-content { background: white; padding: 20px; border-radius: 12px; width: 95%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

<div id="cropModal">
    <div class="crop-content">
        <h3>Crop Pas Foto</h3>
        <div id="cropArea"></div>
        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn" onclick="closeCrop()">Batal</button>
            <button class="btn" style="background:#000; color:white" onclick="applyCrop()">Potong</button>
        </div>
    </div>
</div>

<header>
    <div class="nav-flex container">
        <div class="logo"><i class="fas fa-file-invoice"></i> Cat CV Generator (CCG)</div>
        <div>
            <button onclick="clearAllData()" class="btn" style="background: #f1f5f9; margin-right: 10px;"><i class="fas fa-trash"></i> Hapus Data</button>
            <button onclick="window.location.reload()" class="btn"><i class="fas fa-sync"></i> Reset</button>
        </div>
</header>

<main class="container">
    <div class="editor-container">
        <div class="form-card">
            <button id="exportBtn" class="btn btn-success"><i class="fas fa-file-pdf"></i> DOWNLOAD PDF</button>

            <div class="color-picker-group">
                <div class="color-picker-item">
                    <label><i class="fas fa-palette"></i> Warna Tema:</label>
                    <input type="color" class="color-input" id="inColor" value="#000000" oninput="handleInput()">
                </div>
                <div class="color-picker-item">
                    <label><i class="fas fa-heading"></i> Warna Judul & Sosmed:</label>
                    <input type="color" class="color-input" id="inTitleColor" value="#000000" oninput="handleInput()">
                </div>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-camera"></i> Foto</h3>
                <input type="file" id="uploadFoto" accept="image/*">
            </div>

            <div class="section-box">
                <h3><i class="fas fa-id-card"></i> Informasi Kontak</h3>
                <div class="form-group"><label>Nama Lengkap</label><input type="text" id="inNama" oninput="handleInput()"></div>
                <div class="form-group"><label>Judul Profesional</label><input type="text" id="inJudul" oninput="handleInput()"></div>
                <div class="form-group"><label>Email</label><input type="text" id="inEmail" oninput="handleInput()"></div>
                <div class="form-group"><label>No. HP / WhatsApp</label><input type="text" id="inTelp" oninput="handleInput()"></div>
                <div class="form-group"><label>Tempat, Tanggal Lahir & Umur</label><input type="text" id="inTtl" oninput="handleInput()"></div>
                <div class="form-group"><label>Alamat (Kota, Provinsi)</label><input type="text" id="inAlamat" oninput="handleInput()"></div>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-share-nodes"></i> Media Sosial & Portfolio</h3>
                <div class="form-group"><label>Website Portfolio</label><input type="text" id="inWeb" oninput="handleInput()" placeholder="www.domain.com"></div>
                <div class="form-group"><label>LinkedIn</label><input type="text" id="inLi" oninput="handleInput()"></div>
                <div class="form-group"><label>Instagram</label><input type="text" id="inIg" oninput="handleInput()"></div>
                <div class="form-group"><label>Facebook</label><input type="text" id="inFb" oninput="handleInput()"></div>
                <div class="form-group"><label>YouTube</label><input type="text" id="inYt" oninput="handleInput()"></div>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-user-tie"></i> Ringkasan Profil</h3>
                <textarea id="inProfil" oninput="handleInput()" rows="4"></textarea>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-graduation-cap"></i> Pendidikan</h3>
                <div id="eduList"></div>
                <button onclick="addItem('eduList')" class="btn btn-add">+ Tambah</button>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-briefcase"></i> Pengalaman Kerja</h3>
                <div id="expList"></div>
                <button onclick="addItem('expList')" class="btn btn-add">+ Tambah</button>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-tools"></i> Keahlian (Skill)</h3>
                <div id="skillList"></div>
                <button onclick="addSkillItem()" class="btn btn-add">+ Tambah Skill</button>
            </div>

            <div class="section-box">
                <h3><i class="fas fa-award"></i> Sertifikat dan Prestasi</h3>
                <div id="certList"></div>
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Contoh: "Sertifikat Google Analytics (Google) - 2023"
                </div>
                <button onclick="addCertItem()" class="btn btn-add">+ Tambah Sertifikat/Prestasi</button>
            </div>
        </div>

        <div class="preview-pane">
            <div id="previewContainer">
                <!-- Halaman CV akan ditambahkan dinamis di sini -->
            </div>
        </div>
    </div>
</main>

<script>
    let croppieInstance;
    let counter = { edu: 0, exp: 0, skill: 0, cert: 0 };
    let currentPhoto = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
    let autoSaveTimeout;

    // Handle input - sync langsung, save dengan debounce
    function handleInput() {
        // Sync preview langsung
        sync();
        
        // Save data dengan debounce
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            saveData();
        }, 500);
    }

    // Auto-save system
    function saveData() {
        const data = {
            // Basic info
            inNama: document.getElementById('inNama').value,
            inJudul: document.getElementById('inJudul').value,
            inEmail: document.getElementById('inEmail').value,
            inTelp: document.getElementById('inTelp').value,
            inTtl: document.getElementById('inTtl').value,
            inAlamat: document.getElementById('inAlamat').value,
            inProfil: document.getElementById('inProfil').value,
            
            // Social media
            inWeb: document.getElementById('inWeb').value,
            inLi: document.getElementById('inLi').value,
            inIg: document.getElementById('inIg').value,
            inFb: document.getElementById('inFb').value,
            inYt: document.getElementById('inYt').value,
            
            // Colors
            inColor: document.getElementById('inColor').value,
            inTitleColor: document.getElementById('inTitleColor').value,
            
            // Photo
            currentPhoto: currentPhoto,
            
            // Education items
            eduItems: [],
            
            // Experience items
            expItems: [],
            
            // Skill items
            skillItems: [],
            
            // Certificate items (hanya satu kolom sekarang)
            certItems: [],
            
            // Counters
            counter: counter
        };
        
        // Save education items
        document.querySelectorAll('#eduList .section-box').forEach(box => {
            data.eduItems.push({
                title: box.querySelector('.i-title').value,
                sub: box.querySelector('.i-sub').value,
                date: box.querySelector('.i-date').value
            });
        });
        
        // Save experience items
        document.querySelectorAll('#expList .section-box').forEach(box => {
            data.expItems.push({
                title: box.querySelector('.i-title').value,
                sub: box.querySelector('.i-sub').value,
                date: box.querySelector('.i-date').value,
                desc: box.querySelector('.i-desc')?.value || ''
            });
        });
        
        // Save skill items
        document.querySelectorAll('#skillList .skill-input').forEach(input => {
            data.skillItems.push(input.value);
        });
        
        // Save certificate items (hanya satu kolom)
        document.querySelectorAll('#certList .cert-input').forEach(input => {
            if (input.value.trim()) {
                data.certItems.push(input.value.trim());
            }
        });
        
        localStorage.setItem('cvData', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('cvData');
        if (!saved) return false;
        
        try {
            const data = JSON.parse(saved);
            
            // Load basic info
            document.getElementById('inNama').value = data.inNama || '';
            document.getElementById('inJudul').value = data.inJudul || '';
            document.getElementById('inEmail').value = data.inEmail || '';
            document.getElementById('inTelp').value = data.inTelp || '';
            document.getElementById('inTtl').value = data.inTtl || '';
            document.getElementById('inAlamat').value = data.inAlamat || '';
            document.getElementById('inProfil').value = data.inProfil || '';
            
            // Load social media
            document.getElementById('inWeb').value = data.inWeb || '';
            document.getElementById('inLi').value = data.inLi || '';
            document.getElementById('inIg').value = data.inIg || '';
            document.getElementById('inFb').value = data.inFb || '';
            document.getElementById('inYt').value = data.inYt || '';
            
            // Load colors
            document.getElementById('inColor').value = data.inColor || '#000000';
            document.getElementById('inTitleColor').value = data.inTitleColor || '#000000';
            
            // Load photo
            if (data.currentPhoto) {
                currentPhoto = data.currentPhoto;
            }
            
            // Load counters
            if (data.counter) {
                counter = data.counter;
            }
            
            // Load education items
            const eduList = document.getElementById('eduList');
            eduList.innerHTML = '';
            if (data.eduItems && data.eduItems.length > 0) {
                data.eduItems.forEach((item, index) => {
                    counter.edu = Math.max(counter.edu, index + 1);
                    const html = `
                        <div class="section-box" id="eduList_item${index + 1}" style="background:#fff; margin-top: 10px;">
                            <button onclick="removeItem('eduList', ${index + 1})" style="float:right; border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
                            <input type="text" class="i-title" placeholder="Sekolah" value="${item.title || ''}" oninput="handleInput()" style="margin-bottom:5px">
                            <input type="text" class="i-sub" placeholder="Gelar" value="${item.sub || ''}" oninput="handleInput()" style="margin-bottom:5px">
                            <input type="text" class="i-date" placeholder="Tahun" value="${item.date || ''}" oninput="handleInput()" style="margin-bottom:5px">
                        </div>
                    `;
                    eduList.insertAdjacentHTML('beforeend', html);
                });
            }
            
            // Load experience items
            const expList = document.getElementById('expList');
            expList.innerHTML = '';
            if (data.expItems && data.expItems.length > 0) {
                data.expItems.forEach((item, index) => {
                    counter.exp = Math.max(counter.exp, index + 1);
                    const html = `
                        <div class="section-box" id="expList_item${index + 1}" style="background:#fff; margin-top: 10px;">
                            <button onclick="removeItem('expList', ${index + 1})" style="float:right; border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
                            <input type="text" class="i-title" placeholder="Perusahaan" value="${item.title || ''}" oninput="handleInput()" style="margin-bottom:5px">
                            <input type="text" class="i-sub" placeholder="Posisi" value="${item.sub || ''}" oninput="handleInput()" style="margin-bottom:5px">
                            <input type="text" class="i-date" placeholder="Tahun" value="${item.date || ''}" oninput="handleInput()" style="margin-bottom:5px">
                            <textarea class="i-desc" placeholder="Deskripsi" oninput="handleInput()" rows="2">${item.desc || ''}</textarea>
                        </div>
                    `;
                    expList.insertAdjacentHTML('beforeend', html);
                });
            }
            
            // Load skill items
            const skillList = document.getElementById('skillList');
            skillList.innerHTML = '';
            if (data.skillItems && data.skillItems.length > 0) {
                data.skillItems.forEach((skill, index) => {
                    counter.skill = Math.max(counter.skill, index + 1);
                    const html = `
                        <div class="form-group" id="skill_item${index + 1}" style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
                            <input type="text" class="skill-input" placeholder="Contoh: JavaScript, Komunikasi, Photoshop" value="${skill || ''}" oninput="handleInput()" style="flex: 1;">
                            <button onclick="removeSkillItem(${index + 1})" style="border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
                        </div>
                    `;
                    skillList.insertAdjacentHTML('beforeend', html);
                });
            }
            
            // Load certificate items (hanya satu kolom)
            const certList = document.getElementById('certList');
            certList.innerHTML = '';
            if (data.certItems && data.certItems.length > 0) {
                data.certItems.forEach((cert, index) => {
                    counter.cert = Math.max(counter.cert, index + 1);
                    const html = `
                        <div class="form-group" id="cert_item${index + 1}" style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
                            <input type="text" class="cert-input" placeholder="Contoh: Sertifikat Google Analytics (Google) - 2023" value="${cert || ''}" oninput="handleInput()" style="flex: 1;">
                            <button onclick="removeCertItem(${index + 1})" style="border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
                        </div>
                    `;
                    certList.insertAdjacentHTML('beforeend', html);
                });
            }
            
            return true;
        } catch (e) {
            console.error('Error loading saved data:', e);
            return false;
        }
    }

    function clearAllData() {
        if (confirm('Apakah Anda yakin ingin menghapus semua data? Tindakan ini tidak dapat dibatalkan.')) {
            localStorage.removeItem('cvData');
            window.location.reload();
        }
    }

    document.getElementById('uploadFoto').addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('cropModal').style.display = 'flex';
                if (croppieInstance) croppieInstance.destroy();
                croppieInstance = new Croppie(document.getElementById('cropArea'), {
                    viewport: { width: 160, height: 160, type: 'square' },
                    boundary: { width: 260, height: 260 },
                    showZoomer: true
                });
                croppieInstance.bind({ url: e.target.result });
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    function applyCrop() {
        croppieInstance.result({ type: 'base64', size: 'viewport' }).then(function(base) {
            currentPhoto = base;
            sync();
            saveData();
            closeCrop();
        });
    }

    function closeCrop() { document.getElementById('cropModal').style.display = 'none'; }

    function addItem(listId) {
        const isExp = listId === 'expList';
        counter[listId === 'expList' ? 'exp' : 'edu']++;
        const id = counter[listId === 'expList' ? 'exp' : 'edu'];
        
        const html = `
            <div class="section-box" id="${listId}_item${id}" style="background:#fff; margin-top: 10px;">
                <button onclick="removeItem('${listId}', ${id})" style="float:right; border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
                <input type="text" class="i-title" placeholder="${isExp ? 'Perusahaan' : 'Sekolah'}" oninput="handleInput()" style="margin-bottom:5px">
                <input type="text" class="i-sub" placeholder="${isExp ? 'Posisi' : 'Gelar'}" oninput="handleInput()" style="margin-bottom:5px">
                <input type="text" class="i-date" placeholder="Tahun" oninput="handleInput()" style="margin-bottom:5px">
                ${isExp ? `<textarea class="i-desc" placeholder="Deskripsi" oninput="handleInput()" rows="2"></textarea>` : ''}
            </div>
        `;
        document.getElementById(listId).insertAdjacentHTML('beforeend', html);
        sync();
        saveData();
    }

    function addSkillItem() {
        counter.skill++;
        const id = counter.skill;
        
        const html = `
            <div class="form-group" id="skill_item${id}" style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
                <input type="text" class="skill-input" placeholder="Contoh: JavaScript, Komunikasi, Photoshop" oninput="handleInput()" style="flex: 1;">
                <button onclick="removeSkillItem(${id})" style="border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
            </div>
        `;
        document.getElementById('skillList').insertAdjacentHTML('beforeend', html);
        sync();
        saveData();
    }

    function addCertItem() {
        counter.cert++;
        const id = counter.cert;
        
        const html = `
            <div class="form-group" id="cert_item${id}" style="display: flex; gap: 5px; align-items: center; margin-top: 5px;">
                <input type="text" class="cert-input" placeholder="Contoh: Sertifikat Google Analytics (Google) - 2023" oninput="handleInput()" style="flex: 1;">
                <button onclick="removeCertItem(${id})" style="border:none; color:red; background:none; cursor:pointer; font-size: 1.2rem;">×</button>
            </div>
        `;
        document.getElementById('certList').insertAdjacentHTML('beforeend', html);
        sync();
        saveData();
    }

    function removeItem(listId, id) { 
        document.getElementById(`${listId}_item${id}`).remove(); 
        sync();
        saveData();
    }

    function removeSkillItem(id) { 
        document.getElementById(`skill_item${id}`).remove(); 
        sync();
        saveData();
    }

    function removeCertItem(id) { 
        document.getElementById(`cert_item${id}`).remove(); 
        sync();
        saveData();
    }

    function sync() {
        const selectedColor = document.getElementById('inColor').value;
        const titleColor = document.getElementById('inTitleColor').value;
        
        document.documentElement.style.setProperty('--accent-color', selectedColor);
        document.documentElement.style.setProperty('--title-color', titleColor);
        
        renderPreview();
    }

    function renderPreview() {
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = '';
        
        let currentPage = createPage(1);
        let currentHeight = 0;
        const maxPageHeight = 297 * 3.78 * 0.85;
        
        const sections = [
            renderHeader(),
            renderProfile(),
            renderEducation(),
            renderExperience(),
            renderSkills(),
            renderCertificates(),
            renderSocial()
        ];
        
        sections.forEach(section => {
            const sectionHeight = estimateHeight(section);
            
            if (currentHeight + sectionHeight > maxPageHeight && currentHeight > 0) {
                addPageNumber(currentPage, previewContainer.children.length + 1);
                previewContainer.appendChild(currentPage);
                currentPage = createPage(previewContainer.children.length + 1);
                currentHeight = 0;
            }
            
            currentPage.appendChild(section);
            currentHeight += sectionHeight;
        });
        
        // Tambah nomor halaman untuk halaman terakhir
        addPageNumber(currentPage, previewContainer.children.length + 1);
        previewContainer.appendChild(currentPage);
    }

    function createPage(pageNumber) {
        const page = document.createElement('div');
        page.className = 'cv-page';
        
        if (pageNumber === 1) {
            const mainTitle = document.createElement('div');
            mainTitle.className = 'cv-main-title';
            mainTitle.textContent = 'Curriculum Vitae';
            page.appendChild(mainTitle);
        }
        
        return page;
    }

    function addPageNumber(page, pageNumber) {
        const pageNumElement = document.createElement('div');
        pageNumElement.className = 'page-number';
        pageNumElement.textContent = `Page ${pageNumber}`;
        page.appendChild(pageNumElement);
    }

    function estimateHeight(element) {
        const temp = document.createElement('div');
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        temp.style.width = '210mm';
        temp.appendChild(element.cloneNode(true));
        document.body.appendChild(temp);
        const height = temp.offsetHeight;
        document.body.removeChild(temp);
        return height;
    }

    function renderHeader() {
        const header = document.createElement('div');
        header.className = 'cv-header';
        header.innerHTML = `
            <div class="cv-photo-box">
                <img id="outFoto" src="${currentPhoto}">
            </div>
            <div class="cv-name-zone">
                <h1 id="outNama">${document.getElementById('inNama').value || "NAMA LENGKAP"}</h1>
                <p id="outJudul" style="color: ${document.getElementById('inColor').value}">${document.getElementById('inJudul').value || "Judul Profesional"}</p>
                <div class="cv-contact-grid">
                    <div style="display: flex; flex-direction: column; gap: 3px;">
                        <div class="cv-contact-item"><i class="fas fa-envelope"></i> <span id="outEmail">${document.getElementById('inEmail').value || "-"}</span></div>
                        <div class="cv-contact-item"><i class="fas fa-birthday-cake"></i> <span id="outTtl">${document.getElementById('inTtl').value || "-"}</span></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 3px;">
                        <div class="cv-contact-item"><i class="fas fa-phone"></i> <span id="outTelp">${document.getElementById('inTelp').value || "-"}</span></div>
                        <div class="cv-contact-item"><i class="fas fa-map-marker-alt"></i> <span id="outAlamat">${document.getElementById('inAlamat').value || "-"}</span></div>
                    </div>
                </div>
            </div>
        `;
        return header;
    }

    function renderProfile() {
        const profile = document.createElement('div');
        const profilText = document.getElementById('inProfil').value;
        if (!profilText) return document.createElement('div');
        
        profile.innerHTML = `
            <div class="cv-sec-title">Profil</div>
            <div class="cv-text">${profilText}</div>
        `;
        return profile;
    }

    function renderEducation() {
        const container = document.createElement('div');
        let content = '';
        
        document.querySelectorAll('#eduList .section-box').forEach(box => {
            const title = box.querySelector('.i-title').value;
            const sub = box.querySelector('.i-sub').value;
            const date = box.querySelector('.i-date').value;
            
            if(title || sub || date) {
                content += `
                    <div class="cv-entry">
                        <div class="cv-entry-head">
                            <span class="cv-company">${title || ''}</span>
                            <span class="cv-year">${date || ''}</span>
                        </div>
                        ${sub ? `<span class="cv-entry-posisi">${sub}</span>` : ''}
                    </div>
                `;
            }
        });
        
        if (content) {
            container.innerHTML = `
                <div class="cv-sec-title">Pendidikan</div>
                ${content}
            `;
        }
        return container;
    }

    function renderExperience() {
        const container = document.createElement('div');
        let content = '';
        
        document.querySelectorAll('#expList .section-box').forEach(box => {
            const title = box.querySelector('.i-title').value;
            const sub = box.querySelector('.i-sub').value;
            const date = box.querySelector('.i-date').value;
            const desc = box.querySelector('.i-desc')?.value;
            
            if(title || sub || date) {
                content += `
                    <div class="cv-entry">
                        <div class="cv-entry-head">
                            <span class="cv-company">• ${title || ''}</span>
                            <span class="cv-year">${date || ''}</span>
                        </div>
                        ${sub ? `<span class="cv-entry-posisi">${sub}</span>` : ''}
                        ${desc && desc.trim() ? `<div class="cv-entry-desc">${desc}</div>` : ''}
                    </div>
                `;
            }
        });
        
        if (content) {
            container.innerHTML = `
                <div class="cv-sec-title">Pengalaman Kerja</div>
                ${content}
            `;
        }
        return container;
    }

    function renderSkills() {
        const container = document.createElement('div');
        let skills = [];
        
        document.querySelectorAll('#skillList .skill-input').forEach(input => {
            if (input.value.trim()) {
                skills.push(input.value.trim());
            }
        });
        
        if (skills.length === 0) {
            return document.createElement('div');
        }
        
        const skillsHTML = skills.map(skill => `<span class="cv-badge">${skill}</span>`).join('');
        
        container.innerHTML = `
            <div class="cv-sec-title">Keahlian</div>
            <div class="badge-list">${skillsHTML}</div>
        `;
        
        return container;
    }

    function renderCertificates() {
        const container = document.createElement('div');
        let certificates = [];
        
        // Ambil semua input sertifikat
        document.querySelectorAll('#certList .cert-input').forEach(input => {
            if (input.value.trim()) {
                certificates.push(input.value.trim());
            }
        });
        
        if (certificates.length === 0) {
            return document.createElement('div');
        }
        
        const certsHTML = certificates.map(cert => `
            <div class="cv-certificate-item">
                <div class="cv-certificate-bullet">•</div>
                <div class="cv-certificate-text">${cert}</div>
            </div>
        `).join('');
        
        container.innerHTML = `
            <div class="cv-sec-title">Sertifikat dan Prestasi</div>
            <div class="cv-certificate-list">${certsHTML}</div>
        `;
        
        return container;
    }

    function renderSocial() {
        const container = document.createElement('div');
        const medsos = [
            { id: 'inWeb', icon: 'fas fa-globe' },
            { id: 'inLi', icon: 'fab fa-linkedin' },
            { id: 'inIg', icon: 'fab fa-instagram' },
            { id: 'inFb', icon: 'fab fa-facebook' },
            { id: 'inYt', icon: 'fab fa-youtube' }
        ];
        
        let socialHTML = '';
        medsos.forEach(m => {
            const val = document.getElementById(m.id).value;
            if(val && val.trim() !== "") {
                socialHTML += `<span><i class="${m.icon}"></i> ${val}</span>`;
            }
        });
        
        if (socialHTML) {
            container.className = 'cv-footer-social';
            container.innerHTML = socialHTML;
        }
        
        return container;
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
        const pages = document.querySelectorAll('#previewContainer .cv-page');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        
        const generatePDF = (index) => {
            if (index >= pages.length) {
                pdf.save("CV_Official.pdf");
                return;
            }
            
            const page = pages[index];
            const originalScale = document.documentElement.style.getPropertyValue('--cv-scale');
            page.style.transform = 'none';
            page.style.width = '210mm';
            page.style.height = '297mm';
            
            html2canvas(page, { 
                scale: 3,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                windowWidth: 210 * 3.78,
                windowHeight: 297 * 3.78
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                
                if (index > 0) {
                    pdf.addPage();
                }
                
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                page.style.transform = `scale(${originalScale || '0.55'})`;
                generatePDF(index + 1);
            });
        };
        
        generatePDF(0);
    });

    window.onload = () => { 
        // Try to load saved data
        const dataLoaded = loadData();
        
        // If no saved data, create default items
        if (!dataLoaded) {
            addItem('eduList'); 
            addItem('expList'); 
            addSkillItem();
            addCertItem();
        }
        
        // Initial sync
        sync();
        
        // Add auto-save on page unload
        window.addEventListener('beforeunload', saveData);
    };
</script>
</body>
</html>
